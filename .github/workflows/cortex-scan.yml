name: Cortex CLI Code Scan

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  CORTEX_API_URL: ${{ secrets.CORTEX_API_URL }}
  CORTEX_API_KEY: ${{ secrets.CORTEX_API_KEY }}
  CORTEX_API_KEY_ID: ${{ secrets.CORTEX_API_KEY_ID }}

jobs:
  cortex-code-scan:
    name: Cortex Unified Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download Cortex Unified CLI
        run: |
          echo "Fetching Cortex Unified CLI..."
          crtx_resp=$(curl -s "${{ env.CORTEX_API_URL }}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" \
            -H "x-xdr-auth-id: ${{ env.CORTEX_API_KEY_ID }}" \
            -H "Authorization: ${{ env.CORTEX_API_KEY }}")
          
          crtx_url=$(echo $crtx_resp | jq -r ".signed_url")
          
          curl -s -o cortexcli $crtx_url
          chmod +x cortexcli

      - name: Run Cortex Code Scan
        run: |
          echo "Running scan..."
          
          # 1. Removed invalid '--soft-fail' flag.
          # 2. Added '|| true' at the end. This forces the step to pass (Exit 0)
          #    even if vulns are found, allowing the pipeline to continue.
          # 3. Restored SARIF output so you get the results in GitHub.
          
          ./cortexcli \
            --api-base-url "${{ env.CORTEX_API_URL }}" \
            --api-key "${{ env.CORTEX_API_KEY }}" \
            --api-key-id "${{ env.CORTEX_API_KEY_ID }}" \
            code scan \
            --directory "${{ github.workspace }}" \
            --repo-id "${{ github.repository }}" \
            --branch "${{ github.ref_name }}" \
            --source "GITHUB_ACTIONS" \
            --create-repo-if-missing \
            --output sarif > results.sarif || true

      - name: Upload SARIF to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif
          category: cortex-code-security
